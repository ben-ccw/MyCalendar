<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>農曆及香港假期日曆 (離線版)</title>
    
    <!-- 引入 Tailwind CSS 以實現現代化及響應式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 Lunar-Calendar 庫用於農曆轉換 -->
    <script src="https://unpkg.com/chinese-lunar@1.1.0/dist/lunar.js"></script>

    <style>
        /* 使用 CSS 變數來動態控制字體大小 */
        :root {
            --day-font-size: 0.8rem;
            --holiday-font-size: 0.65rem;
        }

        /* 自訂樣式，確保日曆外觀優美 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .calendar-day {
            aspect-ratio: 1 / 1; 
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            cursor: pointer;
        }
        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .day-number {
            font-size: var(--day-font-size); /* 應用日子文字大小變數 */
        }
        .holiday, .sunday { background-color: #fef2f2; border-color: #fca5a5; }
        .holiday .holiday-name { 
            color: #dc2626; 
            word-break: break-word; 
            font-size: var(--holiday-font-size); /* 應用假期文字大小變數 */
            line-height: 1.2;
        }
        .today { border: 2px solid #3b82f6 !important; background-color: #eff6ff !important; }
        .other-month { color: #9ca3af; background-color: #f9fafb; }
        #notification, #tooltip { transition: opacity 0.3s, transform 0.3s; z-index: 9999; }
        #calendar-container { display: grid; gap: 1.5rem; }
        #settings-modal { transition: opacity 0.3s; }
        #settings-modal > div { transition: transform 0.3s; }

        /* 日期計算高亮樣式 */
        .calc-start-date, .calc-end-date, .calc-in-range {
            background-color: #e0e7ff !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-4 sm:p-6">
        
        <!-- 頂部控制欄 -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
            <div class="flex items-center gap-4">
                <h1 id="calendar-title" class="text-2xl md:text-3xl font-bold text-gray-900"></h1>
            </div>
            
            <div class="flex items-center gap-2 sm:gap-3">
                <div id="days-diff-display" class="font-semibold text-purple-700 mr-2 text-sm"></div>
                <button id="prev-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm">&lt;</button>
                <button id="next-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm">&gt;</button>
                <button id="today-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">今天</button>
                <button id="settings-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm">設定</button>
            </div>
        </div>

        <div id="calendar-container"></div>
    </div>
    
    <!-- 通知及提示框 -->
    <div id="notification" class="hidden fixed top-5 right-5 bg-red-600 text-white py-2 px-4 rounded-lg shadow-lg text-sm opacity-0 transform translate-y-2"></div>
    <div id="tooltip" class="hidden absolute bg-gray-800 text-white text-xs rounded-md py-1 px-2 shadow-lg"></div>
    
    <!-- 日期右鍵/長按選單 -->
    <div id="date-context-menu" class="hidden absolute bg-white shadow-lg rounded-md p-2 z-[100] text-sm border w-48">
        <div id="context-menu-info" class="mb-2 p-1 text-xs text-gray-500 space-y-1"></div>
        <button data-action="set-start" class="block w-full text-left px-3 py-1.5 hover:bg-gray-100 rounded-md">設定為開始日</button>
        <button data-action="set-end" class="block w-full text-left px-3 py-1.5 hover:bg-gray-100 rounded-md">設定為結束日</button>
        <div class="border-t my-1"></div>
        <button data-action="clear" class="block w-full text-left px-3 py-1.5 text-red-600 hover:bg-red-50 rounded-md">清除選擇</button>
    </div>


    <!-- 設定面板 -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold">設定</h2>
                <button id="close-settings-btn" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            
            <div class="space-y-6">
                <!-- 1. 檢視期間 -->
                <div>
                    <label for="view-switcher" class="block text-sm font-medium text-gray-700 mb-1">檢視期間</label>
                    <select id="view-switcher" class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        <option value="month">月</option>
                        <option value="quarter">季</option>
                        <option value="year">年</option>
                    </select>
                </div>
                <!-- 2. 強制橫向月份數 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">強制橫向月份數</label>
                    <div id="columns-options" class="mt-2 grid grid-cols-4 gap-2 rounded-lg bg-gray-100 p-1">
                        <label class="text-center py-2 rounded-md cursor-pointer text-sm transition"><input type="radio" name="columns" value="auto" class="sr-only">自動</label>
                        <label class="text-center py-2 rounded-md cursor-pointer text-sm transition"><input type="radio" name="columns" value="1" class="sr-only">1</label>
                        <label class="text-center py-2 rounded-md cursor-pointer text-sm transition"><input type="radio" name="columns" value="3" class="sr-only">3</label>
                        <label class="text-center py-2 rounded-md cursor-pointer text-sm transition"><input type="radio" name="columns" value="4" class="sr-only">4</label>
                    </div>
                </div>
                <!-- 3. 日子文字大小 -->
                <div>
                    <label for="day-font-size-slider" class="block text-sm font-medium text-gray-700">日子文字大小</label>
                    <input id="day-font-size-slider" type="range" min="0.6" max="1.2" step="0.05" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                 <!-- 4. 假期文字大小 -->
                <div>
                    <label for="holiday-font-size-slider" class="block text-sm font-medium text-gray-700">假期文字大小 (格子內)</label>
                    <input id="holiday-font-size-slider" type="range" min="0.5" max="1.0" step="0.05" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>

            <div class="mt-8 pt-4 border-t">
                 <p id="data-range-info" class="text-xs text-gray-400 text-center"></p>
                <button id="confirm-settings-btn" class="mt-4 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">確定</button>
            </div>
        </div>
    </div>


    <script>
        // ===================================================================================
        // === 假期資料來源 (Holiday Data Source) ===
        // ===================================================================================
        // AI 指示: 若要新增假期資料，請在此處的 `HOLIDAY_DATA_SOURCE` 陣列中，仿照現有格式加入一個新的年份物件。
        // AI INSTRUCTION: To add new holiday data, add a new year object to the `HOLIDAY_DATA_SOURCE` array below, following the existing format.
        // 格式 (Format): { year: YYYY, data: { "YYYY-MM-DD": "假期名稱", ... } }
        //
        const HOLIDAY_DATA_SOURCE = [
            { year: 2018, data: { "2018-01-01": "一月一日", "2018-02-16": "農曆年初一", "2018-02-17": "農曆年初二", "2018-02-19": "農曆年初四", "2018-03-30": "耶穌受難節", "2018-03-31": "耶穌受難節翌日", "2018-04-02": "復活節星期一", "2018-04-05": "清明節", "2018-05-01": "勞動節", "2018-05-22": "佛誕", "2018-06-18": "端午節", "2018-07-02": "香港特別行政區成立紀念日翌日", "2018-09-25": "中秋節翌日", "2018-10-01": "國慶日", "2018-10-17": "重陽節", "2018-12-25": "聖誕節", "2018-12-26": "聖誕節後第一個周日" }},
            { year: 2019, data: { "2019-01-01": "一月一日", "2019-02-05": "農曆年初一", "2019-02-06": "農曆年初二", "2019-02-07": "農曆年初三", "2019-04-05": "清明節", "2019-04-19": "耶穌受難節", "2019-04-20": "耶穌受難節翌日", "2019-04-22": "復活節星期一", "2019-05-01": "勞動節", "2019-05-13": "佛誕翌日", "2019-06-07": "端午節", "2019-07-01": "香港特別行政區成立紀念日", "2019-09-14": "中秋節翌日", "2019-10-01": "國慶日", "2019-10-07": "重陽節", "2019-12-25": "聖誕節", "2019-12-26": "聖誕節後第一個周日" }},
            { year: 2020, data: { "2020-01-01": "一月一日", "2020-01-25": "農曆年初一", "2020-01-27": "農曆年初三", "2020-01-28": "農曆年初四", "2020-04-04": "清明節", "2020-04-10": "耶穌受難節", "2020-04-11": "耶穌受難節翌日", "2020-04-13": "復活節星期一", "2020-04-30": "佛誕", "2020-05-01": "勞動節", "2020-06-25": "端午節", "2020-07-01": "香港特別行政區成立紀念日", "2020-10-01": "國慶日", "2020-10-02": "中秋節翌日", "2020-10-26": "重陽節翌日", "2020-12-25": "聖誕節" }},
            { year: 2021, data: { "2021-01-01": "一月一日", "2021-02-12": "農曆年初一", "2021-02-13": "農曆年初二", "2021-02-15": "農曆年初四", "2021-04-02": "耶穌受難節", "2021-04-03": "耶穌受難節翌日", "2021-04-05": "復活節星期一", "2021-04-06": "清明節翌日", "2021-05-01": "勞動節", "2021-05-19": "佛誕", "2021-06-14": "端午節", "2021-07-01": "香港特別行政區成立紀念日", "2021-09-22": "中秋節翌日", "2021-10-01": "國慶日", "2021-10-14": "重陽節", "2021-12-25": "聖誕節", "2021-12-27": "聖誕節後第一個周日" }},
            { year: 2022, data: { "2022-01-01": "一月一日", "2022-02-01": "農曆年初一", "2022-02-02": "農曆年初二", "2022-02-03": "農曆年初三", "2022-04-05": "清明節", "2022-04-15": "耶穌受難節", "2022-04-16": "耶穌受難節翌日", "2022-04-18": "復活節星期一", "2022-05-02": "勞動節翌日", "2022-05-09": "佛誕翌日", "2022-06-03": "端午節", "2022-07-01": "香港特別行政區成立紀念日", "2022-09-12": "中秋節翌日", "2022-10-01": "國慶日", "2022-10-04": "重陽節", "2022-12-26": "聖誕節後第一個周日", "2022-12-27": "聖誕節後第二個周日" }},
            { year: 2023, data: { "2023-01-02": "一月一日翌日", "2023-01-23": "農曆年初二", "2023-01-24": "農曆年初三", "2023-01-25": "農曆年初四", "2023-04-05": "清明節", "2023-04-07": "耶穌受難節", "2023-04-08": "耶穌受難節翌日", "2023-04-10": "復活節星期一", "2023-05-01": "勞動節", "2023-05-26": "佛誕", "2023-06-22": "端午節", "2023-07-01": "香港特別行政區成立紀念日", "2023-09-30": "中秋節翌日", "2023-10-02": "國慶日翌日", "2023-10-23": "重陽節", "2023-12-25": "聖誕節", "2023-12-26": "聖誕節後第一個周日" }},
            { year: 2024, data: { "2024-01-01": "一月一日", "2024-02-10": "農曆年初一", "2024-02-12": "農曆年初三", "2024-02-13": "農曆年初四", "2024-03-29": "耶穌受難節", "2024-03-30": "耶穌受難節翌日", "2024-04-01": "復活節星期一", "2024-04-04": "清明節", "2024-05-01": "勞動節", "2024-05-15": "佛誕", "2024-06-10": "端午節", "2024-07-01": "香港特別行政區成立紀念日", "2024-09-18": "中秋節翌日", "2024-10-01": "國慶日", "2024-10-11": "重陽節", "2024-12-25": "聖誕節", "2024-12-26": "聖誕節後第一個周日" }},
            { year: 2025, data: { "2025-01-01": "一月一日", "2025-01-29": "農曆年初一", "2025-01-30": "農曆年初二", "2025-01-31": "農曆年初三", "2025-04-04": "清明節", "2025-04-18": "耶穌受難節", "2025-04-19": "耶穌受難節翌日", "2025-04-21": "復活節星期一", "2025-05-01": "勞動節", "2025-05-05": "佛誕", "2025-05-31": "端午節", "2025-07-01": "香港特別行政區成立紀念日", "2025-10-01": "國慶日", "2025-10-07": "中秋節翌日", "2025-10-29": "重陽節", "2025-12-25": "聖誕節", "2025-12-26": "聖誕節後第一個周日" }},
            { year: 2026, data: { "2026-01-01": "一月一日", "2026-02-17": "農曆年初一", "2026-02-18": "農曆年初二", "2026-02-19": "農曆年初三", "2026-04-03": "耶穌受難節", "2026-04-04": "耶穌受難節翌日", "2026-04-06": "復活節星期一", "2026-05-01": "勞動節", "2026-05-25": "佛誕", "2026-06-19": "端午節", "2026-07-01": "香港特別行政區成立紀念日", "2026-09-26": "中秋節翌日", "2026-10-01": "國慶日", "2026-10-19": "重陽節", "2026-12-25": "聖誕節", "2026-12-26": "聖誕節後第一個周日" }}
        ];
        // ===================================================================================
        // === 程式碼邏輯開始 (Application Logic Starts) ===
        // ===================================================================================

        // --- 全域狀態和設定 ---
        let currentDate = new Date();
        let currentView = 'year';
        let forcedColumns = 'auto';
        let holidays = {};
        let dayFontSize = 0.8;
        let holidayFontSize = 0.65;
        let pinnedTooltip = { element: null, isPinned: false };
        let calcStartDate = null;
        let calcEndDate = null;
        let longPressTimer = null;
        let contextMenuTargetDate = null;

        // --- DOM 元素 ---
        const calendarTitle = document.getElementById('calendar-title');
        const calendarContainer = document.getElementById('calendar-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const todayBtn = document.getElementById('today-btn');
        const notification = document.getElementById('notification');
        const tooltip = document.getElementById('tooltip');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const viewSwitcher = document.getElementById('view-switcher');
        const columnsOptions = document.getElementById('columns-options');
        const confirmSettingsBtn = document.getElementById('confirm-settings-btn');
        const dayFontSizeSlider = document.getElementById('day-font-size-slider');
        const holidayFontSizeSlider = document.getElementById('holiday-font-size-slider');
        const daysDiffDisplay = document.getElementById('days-diff-display');
        const dateContextMenu = document.getElementById('date-context-menu');
        const contextMenuInfo = document.getElementById('context-menu-info');
        const dataRangeInfo = document.getElementById('data-range-info');

        // --- 核心輔助函式 ---
        
        function showNotification(message, isError = true) {
            notification.textContent = message;
            notification.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg text-sm opacity-0 transform translate-y-2 ${isError ? 'bg-red-600' : 'bg-green-500'}`;
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-y-2');
                notification.classList.add('opacity-100', 'translate-y-0');
            }, 10);
            setTimeout(() => {
                notification.classList.remove('opacity-100', 'translate-y-0');
                notification.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => notification.classList.add('hidden'), 500);
            }, 3000);
        }

        function loadHolidaysForYear(year) {
            if (holidays[year]) { return; } 

            const yearData = HOLIDAY_DATA_SOURCE.find(item => item.year === year);

            if (yearData) {
                holidays[year] = { 'tc': yearData.data };
            } else {
                holidays[year] = { 'tc': {} }; // 建立空物件以避免錯誤
            }
        }

        function analyzeHolidayDisplayMode() {
            if (currentView !== 'month' || (forcedColumns !== 'auto' && forcedColumns !== '1')) {
                return 'asterisk';
            }
            return 'full';
        }

        function scrollToCurrentMonth() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const targetId = `month-container-${year}-${month}`;
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
                setTimeout(() => {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                        inline: 'center'
                    });
                    targetElement.classList.add('border-4', 'border-blue-400', 'rounded-lg', 'transition-all', 'duration-1000');
                    setTimeout(() => {
                         targetElement.classList.remove('border-4', 'border-blue-400', 'rounded-lg');
                    }, 2500);
                }, 150);
            }
        }

        // --- 核心渲染函式 ---

        function render() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            updateUIText();
            loadHolidaysForYear(year);
            if (currentView === 'year') {
                loadHolidaysForYear(year + 1);
            }
            
            calendarContainer.innerHTML = '';

            switch (currentView) {
                case 'year': renderYearView(year); break;
                case 'quarter': renderQuarterView(year, month); break;
                default: renderMonthView(year, month); break;
            }
        }
        
        function getContainerGridClasses() {
            if (forcedColumns !== 'auto') { return `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-${forcedColumns} gap-4`; }
            switch (currentView) {
                case 'year': return 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';
                case 'quarter': return 'grid grid-cols-1 lg:grid-cols-3 gap-6';
                default: return 'grid grid-cols-1';
            }
        }

        function renderMonthView(year, month) {
            calendarContainer.className = getContainerGridClasses();
            calendarContainer.appendChild(createMonthContainer(year, month));
        }

        function renderQuarterView(year, month) {
            calendarContainer.className = getContainerGridClasses();
            const startMonth = Math.floor(month / 3) * 3;
            for (let i = 0; i < 3; i++) {
                const date = new Date(year, startMonth + i, 1);
                calendarContainer.appendChild(createMonthContainer(date.getFullYear(), date.getMonth()));
            }
        }

        function renderYearView(year) {
            calendarContainer.className = getContainerGridClasses();
            for (let month = 0; month < 12; month++) {
                calendarContainer.appendChild(createMonthContainer(year, month));
            }
        }

        function createMonthContainer(year, month) {
            const holidayData = (holidays[year] && holidays[year]['tc']) ? holidays[year]['tc'] : {};
            const container = document.createElement('div');
            container.id = `month-container-${year}-${month}`;
            const title = document.createElement('h3');
            title.className = 'text-xl font-semibold text-center mb-2 bg-gray-100 p-2 rounded-t-lg';
            title.textContent = `${year} ${['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'][month]}`;

            const weekdaysHeader = document.createElement('div');
            weekdaysHeader.className = 'calendar-grid mb-1 text-center font-semibold text-gray-500 text-sm';
            ['日', '一', '二', '三', '四', '五', '六'].forEach(day => { weekdaysHeader.innerHTML += `<div>${day}</div>`; });

            const grid = document.createElement('div');
            grid.className = 'calendar-grid';
            
            const displayMode = analyzeHolidayDisplayMode();

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonth = new Date(year, month, 0);
            for (let i = firstDayOfMonth - 1; i >= 0; i--) {
                grid.appendChild(createDayCell(new Date(prevMonth.getFullYear(), prevMonth.getMonth(), prevMonth.getDate() - i), true, {}, displayMode));
            }
            for (let i = 1; i <= daysInMonth; i++) {
                grid.appendChild(createDayCell(new Date(year, month, i), false, holidayData, displayMode));
            }
            const totalCells = firstDayOfMonth + daysInMonth;
            const nextMonth = new Date(year, month + 1, 1);
            for (let i = 1; i <= (totalCells > 35 ? 42 : 35) - totalCells; i++) {
                grid.appendChild(createDayCell(new Date(nextMonth.getFullYear(), nextMonth.getMonth(), i), true, {}, displayMode));
            }

            const holidayListContainer = document.createElement('div');
            holidayListContainer.className = 'mt-4 pt-3 border-t text-sm space-y-1 h-28 min-h-28 overflow-y-auto';
            let hasHolidays = false;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const holidayName = holidayData[dateString];
                if (holidayName) {
                    hasHolidays = true;
                    const holidayItem = document.createElement('div');
                    holidayItem.className = 'flex justify-between items-center';
                    holidayItem.innerHTML = `<span class="font-semibold text-red-600 w-16">${month + 1}月${day}日</span><span class="text-red-600 text-right flex-1">${holidayName}</span>`;
                    holidayListContainer.appendChild(holidayItem);
                }
            }
            if (!hasHolidays) {
                const noHolidayItem = document.createElement('div');
                noHolidayItem.className = 'text-sm text-gray-500 text-center py-2';
                noHolidayItem.textContent = '本月沒有公眾假期';
                holidayListContainer.appendChild(noHolidayItem);
            }

            container.append(title, weekdaysHeader, grid, holidayListContainer);
            return container;
        }

        function createDayCell(date, isOtherMonth, holidayData, displayMode) {
            const dayCell = document.createElement('div');
            const day = date.getDate();
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayCell.dataset.date = dateString;

            const isToday = date.toDateString() === new Date().toDateString();
            const isSunday = date.getDay() === 0;
            let lunarText = '';
            if (typeof lunar !== 'undefined') {
                const d = lunar.solarToLunar(year, month, day);
                lunarText = d.lunarFestival || d.solarTerm || (d.day === 1 ? `${d.monthInChinese}月` : d.dayInChinese);
            }
            let cellClasses = 'calendar-day border rounded-md p-1 flex flex-col';
            if (isOtherMonth) cellClasses += ' other-month';
            
            const holidayName = holidayData[dateString];
            if (!isOtherMonth && (holidayName || isSunday)) {
                cellClasses += isSunday ? ' sunday' : ' holiday';
            }

            if (calcStartDate && calcEndDate) {
                const currentDate = new Date(dateString);
                const start = new Date(calcStartDate);
                const end = new Date(calcEndDate);
                if (currentDate >= start && currentDate <= end) {
                    cellClasses += ' calc-in-range';
                }
            } else if (calcStartDate && dateString === calcStartDate) {
                cellClasses += ' calc-in-range';
            }
            
            if (isToday) cellClasses += ' today';

            dayCell.className = cellClasses;

            let dayNumberClasses = 'day-number font-bold';
            if (!isOtherMonth) {
                if (holidayName) {
                    dayNumberClasses += ' text-red-600';
                } else {
                    dayNumberClasses += ' text-gray-900';
                }
            }

            let holidayDisplayHtml = '';
            if (holidayName && !isOtherMonth) {
                dayCell.dataset.tooltip = holidayName;
                if (displayMode === 'asterisk') {
                    holidayDisplayHtml = `<div class="holiday-name font-semibold mt-auto pt-1 text-center">*</div>`;
                } else {
                    holidayDisplayHtml = `<div class="holiday-name font-semibold mt-auto pt-1">${holidayName}</div>`;
                }
            }
            dayCell.innerHTML = `
                <div class="${dayNumberClasses}">${day}</div>
                <div class="text-xs text-gray-500 truncate">${lunarText || '&nbsp;'}</div>
                <div class="flex-grow"></div>
                ${holidayDisplayHtml}
            `;
            return dayCell;
        }
        
        function updateDateHighlights() {
            document.querySelectorAll('.calendar-day').forEach(cell => {
                cell.classList.remove('calc-in-range');
                const dateString = cell.dataset.date;
                if (!dateString) return;

                const date = new Date(dateString);
                if (calcStartDate && calcEndDate) {
                    const start = new Date(calcStartDate);
                    const end = new Date(calcEndDate);
                    if (date >= start && date <= end) {
                        cell.classList.add('calc-in-range');
                    }
                } else if (calcStartDate && dateString === calcStartDate) {
                    cell.classList.add('calc-in-range');
                }
            });
        }

        function updateDaysDiffDisplay() {
            if (calcStartDate && calcEndDate) {
                const start = new Date(calcStartDate);
                const end = new Date(calcEndDate);

                if (end < start) {
                    daysDiffDisplay.textContent = '結束日較早';
                    daysDiffDisplay.classList.add('text-red-500');
                    return;
                }
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                daysDiffDisplay.classList.remove('text-red-500');
                daysDiffDisplay.textContent = `相差 ${diffDays} 天`;
            } else {
                daysDiffDisplay.textContent = '';
            }
        }

        function updateUIText() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const quarterNames = ['第一季', '第二季', '第三季', '第四季'];
            document.title = '農曆及香港假期日曆 (離線版)';
            switch (currentView) {
                case 'year': 
                    calendarTitle.textContent = year; 
                    break;
                case 'quarter': 
                    calendarTitle.textContent = `${year} ${quarterNames[Math.floor(month / 3)]}`; 
                    break;
                default: 
                    calendarTitle.textContent = `${year} ${['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'][month]}`; 
                    break;
            }
        }
        
        function handleNav(direction) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            switch (currentView) {
                case 'year': currentDate.setFullYear(year + direction); break;
                case 'quarter': currentDate.setMonth(month + (3 * direction)); break;
                default: currentDate.setMonth(month + direction); break;
            }
            render();
        }

        function openModal(modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }
        function closeModal(modal) {
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        function showContextMenu(e) {
            e.preventDefault();
            const cell = e.target.closest('.calendar-day');
            if (!cell || cell.classList.contains('other-month')) return;

            contextMenuTargetDate = cell.dataset.date;
            
            let infoHtml = `<div><b>選擇日期:</b> ${contextMenuTargetDate}</div>`;
            if(calcStartDate) infoHtml += `<div>開始日: ${calcStartDate}</div>`;
            if(calcEndDate) infoHtml += `<div>結束日: ${calcEndDate}</div>`;
            contextMenuInfo.innerHTML = infoHtml;

            dateContextMenu.style.left = `${e.pageX}px`;
            dateContextMenu.style.top = `${e.pageY}px`;
            dateContextMenu.classList.remove('hidden');
        }

        function hideContextMenu() {
            dateContextMenu.classList.add('hidden');
        }

        // --- 事件監聽器 ---
        prevBtn.addEventListener('click', () => handleNav(-1));
        nextBtn.addEventListener('click', () => handleNav(1));
        todayBtn.addEventListener('click', () => { 
            currentDate = new Date(); 
            render();
            scrollToCurrentMonth();
        });
        
        settingsBtn.addEventListener('click', () => {
             const firstYear = HOLIDAY_DATA_SOURCE[0].year;
             const lastYear = HOLIDAY_DATA_SOURCE[HOLIDAY_DATA_SOURCE.length - 1].year;
             dataRangeInfo.textContent = `已內建 ${firstYear} - ${lastYear} 年假期資料`;
             openModal(settingsModal);
        });
        closeSettingsBtn.addEventListener('click', () => closeModal(settingsModal));
        confirmSettingsBtn.addEventListener('click', () => closeModal(settingsModal));
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) closeModal(settingsModal);
        });

        viewSwitcher.addEventListener('change', (e) => { currentView = e.target.value; render(); });
        columnsOptions.addEventListener('change', (e) => {
            if (e.target.name === 'columns') {
                forcedColumns = e.target.value;
                document.querySelectorAll('#columns-options label').forEach(label => {
                    label.classList.remove('bg-blue-500', 'text-white');
                    label.classList.add('hover:bg-gray-200');
                });
                e.target.parentElement.classList.add('bg-blue-500', 'text-white');
                render();
            }
        });
        
        dayFontSizeSlider.addEventListener('input', (e) => {
            dayFontSize = e.target.value;
            document.documentElement.style.setProperty('--day-font-size', `${dayFontSize}rem`);
        });

        holidayFontSizeSlider.addEventListener('input', (e) => {
            holidayFontSize = e.target.value;
            document.documentElement.style.setProperty('--holiday-font-size', `${holidayFontSize}rem`);
        });

        calendarContainer.addEventListener('contextmenu', showContextMenu);
        calendarContainer.addEventListener('touchstart', (e) => {
            longPressTimer = setTimeout(() => {
                showContextMenu({
                    preventDefault: () => {},
                    target: e.target,
                    pageX: e.touches[0].pageX,
                    pageY: e.touches[0].pageY
                });
            }, 500);
        });
        calendarContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
        calendarContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        
        dateContextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (action === 'set-start') calcStartDate = contextMenuTargetDate;
            if (action === 'set-end') calcEndDate = contextMenuTargetDate;
            if (action === 'clear') {
                calcStartDate = null;
                calcEndDate = null;
            }
            hideContextMenu();
            updateDateHighlights();
            updateDaysDiffDisplay();
        });

        document.addEventListener('click', (e) => {
            if (!dateContextMenu.contains(e.target)) {
                hideContextMenu();
            }
        });
        
        calendarContainer.addEventListener('mouseover', (e) => {
            const cell = e.target.closest('[data-tooltip]');
            if (cell && !pinnedTooltip.isPinned) {
                tooltip.textContent = cell.dataset.tooltip;
                tooltip.classList.remove('hidden');
                const rect = cell.getBoundingClientRect();
                tooltip.style.left = `${rect.left + window.scrollX}px`;
                tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
            }
        });
        calendarContainer.addEventListener('mouseout', (e) => {
            const cell = e.target.closest('[data-tooltip]');
            if (cell && !pinnedTooltip.isPinned) {
                tooltip.classList.add('hidden');
            }
        });
        calendarContainer.addEventListener('click', (e) => {
            const cell = e.target.closest('[data-tooltip]');
            if (!cell) {
                if (pinnedTooltip.isPinned) {
                    pinnedTooltip.isPinned = false;
                    pinnedTooltip.element = null;
                    tooltip.classList.add('hidden');
                }
                return;
            }

            if (pinnedTooltip.isPinned && pinnedTooltip.element === cell) {
                pinnedTooltip.isPinned = false;
                pinnedTooltip.element = null;
                tooltip.classList.add('hidden');
            } else { 
                pinnedTooltip.isPinned = true;
                pinnedTooltip.element = cell;
                tooltip.textContent = cell.dataset.tooltip;
                tooltip.classList.remove('hidden');
                const rect = cell.getBoundingClientRect();
                tooltip.style.left = `${rect.left + window.scrollX}px`;
                tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
            }
        });

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            viewSwitcher.value = currentView;
            document.querySelector(`#columns-options input[value="${forcedColumns}"]`).checked = true;
            document.querySelector(`#columns-options input[value="${forcedColumns}"]`).parentElement.classList.add('bg-blue-500', 'text-white');
            dayFontSizeSlider.value = dayFontSize;
            holidayFontSizeSlider.value = holidayFontSize;
            document.documentElement.style.setProperty('--day-font-size', `${dayFontSize}rem`);
            document.documentElement.style.setProperty('--holiday-font-size', `${holidayFontSize}rem`);
            
            render();
            scrollToCurrentMonth();
        });

    </script>
</body>
</html>
